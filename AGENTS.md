- # Agent 行为规范（Project Assistant）

  ## Language

  - 始终使用 **简体中文** 回复。

  ------

  ## 0. 设计目标

  本 Agent 的核心目标是：

  1. 在执行任何与仓库行为、实现、架构相关的任务前，**优先访问 `/docs` 文档**；
  2. 采用类似 Claude skill 的**渐进式读取（Progressive Reading）**机制，只读取最小必要信息；
  3. 将文档内容压缩为**引用 + 要点 + 决策依据**，避免整段内容进入上下文；
  4. 减少 AI 直接读取代码的范围与上下文占用；
  5. 确保**功能变更与文档更新同步完成**。

  ------

  ## 1. Core Workflow（Definition of Done）

  当用户请求 **新增 / 修改 / 删除任何功能** 时，必须同时完成：

  1. 功能实现（代码 / 配置 / 逻辑变更）
  2. 文档更新（反映本次变更）

  只有 **两者都完成**，才算任务完成；不得只交付代码而不更新文档。

  ### What counts as "functionality change"

  包括但不限于：

  - 新功能或功能行为变化
  - 参数、默认值变化
  - API / 接口输入输出变化
  - 训练 / 推理流程变化，reward / 环境逻辑变化
  - 配置项新增 / 修改 / 删除
  - 性能优化导致的行为差异或边界条件变化

  ------

  ## 2. 强制规则：任务前必须读取 /docs

  在执行以下任务前，**必须访问 `/docs`**（至少完成索引级读取）：

  - 功能设计、实现或重构
  - 行为、规则、协议、流程相关判断
  - 架构理解、模块职责判断
  - 配置、约定、规范、边界条件问题
  - “应该怎么做 / 推荐做法 / 官方行为” 类问题

  ### 唯一例外（可不读 docs）

  - 与仓库无关的通用知识问答
  - 纯文本润色，不影响行为含义
  - 用户明确声明“忽略项目约定”

  > 若不确定是否属于例外 → **默认先读 `/docs`**。

  ------

  ## 3. 渐进式读取协议（Progressive Reading）

  > 本章节同时定义：
  >
  > 1. Agent 如何读取 docs（渐进式读取）
  > 2. docs 应该如何被编写，以最大限度降低 LLM 误读概率

  ### 3.1 文档统一模板规范（强制）

  docs 中的 **每一篇文档必须遵循统一结构**，以支持 Agent 的渐进式读取，并减少 LLM 误读。

  #### 推荐标准模板

  ```md
  # <Feature / Module Name>
  
  ## Abstract
  - What: 这个功能 / 模块做什么（一句话，不要背景）
  - When: 在什么情况下会用到 / 被触发
  - Not: 明确说明「它不做什么」（防止误用）
  - Key rules:
    - 规则 1（硬约束）
    - 规则 2（默认行为）
  
  ## When to use
  - 典型使用场景
  - 非典型但允许的场景
  
  ## When NOT to use
  - 明确禁止或不推荐的使用方式
  
  ## Behavior / Rules
  - 行为定义（必须是确定性的描述）
  - 优先级规则（如有）
  
  ## Configuration / API
  - 参数说明（含默认值）
  - 必填 / 可选 / 互斥关系
  
  ## Examples
  - 正例（推荐写法）
  - 反例（常见误用）
  
  ## Edge Cases / Gotchas
  - 边界条件
  - 易踩坑点
  
  ## Related Docs
  - 指向其他 docs 的明确链接
  ```

  > Agent 在 Stage C **优先只读取 `Abstract` 与标题结构**。
  > 只有在 Abstract 命中时，才进入后续章节。

  ------

  ### 3.2 Abstract / TL;DR 编写硬规则

  - Abstract **必须是事实陈述**，禁止模糊描述（如“可能”“一般来说”）
  - 必须包含 **Not / When NOT**，主动收缩语义空间
  - 不得出现实现细节、历史背景
  - 控制在 **6–10 行以内**

  **docs 中的每一篇文档，必须在顶部包含一个摘要区块**，用于支持渐进式读取：

  推荐格式之一：

  ```md
  ## Abstract
  - What: 本文档描述的功能 / 模块是什么
  - When: 什么时候需要用到
  - Key rules: 最重要的 2–3 条规则或约束
  ```

  或：

  ```md
  ## TL;DR
  一句话总结 + 关键行为要点
  ```

  Agent 在 Stage C 之前 **优先只读取 Abstract / TL;DR**。

  ------

  ### 3.3 渐进式读取阶段

  #### Stage A：索引扫描（必须）

  目的：建立文档地图，不理解细节。

  读取内容：

  - `/docs/README.md` 或 `/docs/index.md`
  - `/docs` 目录结构（文件名 + 层级）

  产出（仅保留）：

  - 文档路径
  - 标题
  - 一句话用途说明

  ------

  #### Stage B：候选文档筛选

  根据任务关键词（功能名 / 模块名 / 行为描述）：

  - 选择 **1–3 篇最可能相关的文档**
  - 若无明显匹配：
    - 仅扫描标题（`# / ##`）
    - 或 TOC / Summary

  ------

  #### Stage C：浅层读取（判断是否匹配）

  只读取：

  - Abstract / TL;DR
  - 文档简介段
  - 各级标题
  - Usage / How to / API / Constraints

  判断结果：

  - ❌ 不匹配 → 立即停止，切换文档
  - ✅ 匹配 → 进入 Stage D

  ------

  #### Stage D：深度读取（最小必要）

  仅阅读与当前任务**直接相关的章节**：

  - 行为定义
  - 规则与约束
  - 参数 / 配置项
  - 边界条件
  - 对应示例

  禁止全文通读。

  ------

  #### Stage E：校验与决策

  - 文档结论 > 代码直觉 > 经验假设
  - 文档冲突时必须指出
  - 文档不完整时，允许最小范围读代码，并说明原因

  ------

  ### 3.4 停止条件（Just Enough）

  当以下问题全部可回答时，必须停止读取：

  - 期望行为是什么？
  - 有哪些硬约束或推荐约定？
  - 应修改或实现的位置在哪里？
  - 是否存在边界条件或特殊情况？

  ------

  ## 4. 反向设计：如何写 docs 才能减少 LLM 误读

  本章节定义 **docs 的写作规范**，目标不是“给人看”，而是“给 Agent 精准读取”。

  ### 4.1 减少歧义的写作原则（强制）

  - 使用 **确定性动词**：必须 / 禁止 / 只会 / 不会
  - 避免：通常、一般、可能、大多数情况下
  - 一个规则 = 一句话 = 一个行为

  ### 4.2 显式写出边界（不要让 LLM 猜）

  - 永远写：
    - Does
    - Does NOT
  - 如果行为在某条件下变化，必须拆成多条规则

  ### 4.3 优先级必须显式

  禁止隐含优先级。

  错误示例：

  > 如果 A 失败会尝试 B

  正确示例：

  > 1. 先执行 A
  > 2. 仅当 A 失败时，才执行 B

  ### 4.4 示例必须成对出现

  - 每个正例，必须有一个对应反例
  - 反例要明确说明 **为什么错**

  ### 4.5 避免跨文档隐式依赖

  - 不允许“如前文所述”
  - 必须使用 `Related Docs` 显式链接

  ### 4.6 与代码的对应关系

  - 文档中首次出现的概念，必须能在代码中定位到：
    - 文件名 / 模块名 / 配置 key

  ------

  ## 5. 上下文压缩与存储规则

  ### 4.1 禁止文档原文堆入上下文

  文档信息必须压缩为：

  - **DocRef**：路径 + 章节名（可选行号）
  - **关键要点**：3–7 条以内
  - **决策影响**：这些信息如何影响当前实现

  示例：

  - DocRef: `/docs/agent/routing.md#Fallback-Strategy`
  - 关键要点：
    - 优先规则匹配，其次模型推理
    - 置信度 < 0.6 时走默认 handler
  - 决策：
    - 新功能必须注册在 rule 层

  ------

  ### 4.2 上下文预算

  - 文档相关内容 ≤ **1200 tokens**
  - 超出时必须再次压缩为：
    - DocRef + 一句话结论

  ------

  ## 5. Documentation Policy（功能变更必须更新文档）

  ### Where to update docs

  按影响范围选择（可多处）：

  - **README.md**：对外使用方式、快速开始、核心行为变化
  - **docs/**：功能说明、设计说明、参数解释、FAQ
  - **CHANGELOG.md**（如存在）：版本 / 变更记录
  - **代码注释 / docstring**：局部逻辑或接口细节

  ------

  ### Minimum doc update requirements

  每次功能变更后，文档至少包含：

  - **What changed**：变更点一句话总结
  - **Why**：变更原因
  - **How to use / Impact**：使用方式或影响范围
  - **Examples**（如适用）

  ------

  ### If docs are missing or unclear

  - 找不到合适文档 → 提出新建建议（如 `docs/<feature>.md`）
  - 仓库无 docs → 建议创建并给出初始结构

  ------

  ## 6. 输出格式要求（Always）

  除非用户明确不需要，最终输出必须包含：

  1. **变更摘要**
  2. **代码改动**（关键文件 / 接口变化）
  3. **文档改动**（更新了哪些文档及要点）
  4. **验证方式**（如何运行 / 测试）
  5. **风险与回滚**（建议提供）

  同时包含：

  ### Docs consulted

  - 路径 + 章节名（不粘贴原文）

  ### Derived constraints

  - ≤ 7 条，与当前任务直接相关

  ------

  ## 7. Safety / Collaboration

  - 涉及 `git push --force` 必须先说明风险并给出替代方案
  - 需求不清晰时：列出假设并继续可执行部分，不阻塞交付

  ------

  ## 8. Final Checklist

  -  功能是否完成并解释清楚
  -  文档是否已更新或明确给出更新内容
  -  是否提供验证方式
  -  是否说明影响 / 兼容性 / 风险
