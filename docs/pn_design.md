## pn.py 设计说明

本文档说明 `solutions/Continuous_model/pn.py` 的关键设计决策与实现思路。

### 设计目标

- 支持双路线的晶圆加工流程
- 支持双机械手协作并避免拥堵
- 建模驻留约束，模拟真实工艺限制
- 提供可训练的奖励塑形与可视化工具

### 双路线分流

在 `s1` 处根据晶圆颜色决定路线：
- `color=1` 走路线1：`LP1 -> s1 -> s2 -> s3 -> s4 -> s5 -> LP_done`
- `color=2` 走路线2：`LP2 -> s1 -> s5 -> LP_done`

路线上 `s2`/`s4` 为交接缓冲点（无驻留约束），`s1`/`s3`/`s5` 为核心加工腔室（有驻留约束）。

### 释放时间惩罚（离开才检查）

目的：在晶圆**离开某站、承诺进入下游**的时刻才对该下游腔室做释放违规检查，避免在缓冲站（如 LLC）多等即可避免的冲突被提前惩罚。

**规则**：仅在「晶圆离开某站」时对「即将占用的下游腔室」做一次 add_release + 违规检查：

| 离开的站 | 检查的腔室 | 对应变迁 |
|----------|------------|----------|
| LP | s1 | u_LP1_s1, u_LP2_s1 |
| s2 (LLC) | s3, s4 | u_s2_s3（路线1） |
| s4 (LLD) | s5 | u_s4_s5（路线1） |
| s1 → s5 | s5 | u_s1_s5（路线2） |

- **LLC (s2)** 不参与释放链、不施加释放违规惩罚；晶圆可在 LLC 缓冲，以推迟进入 s3/s4 从而避免 LLD 冲突。
- **LLC 容量为 1**：PM7/PM8 近似同时完工时仅一片可进入 LLC，由 capacity 与使能约束保证。

#### release_schedule 与 tokens 的关系

- `release_schedule`：记录**承诺占用**该腔室的晶圆（从进入运输位到离开腔室的整个周期）
- `tokens`：记录**实际在**腔室中的晶圆

生命周期：
1. 晶圆离开上游站（u_变迁）时：`add_release(wafer_id, release_time)` 加入 schedule
2. 晶圆实际进入腔室（t_变迁）时：`update_release(wafer_id, new_time)` 更新精确释放时间
3. 晶圆离开腔室（下一个 u_变迁）时：`pop_release(wafer_id)` 从 schedule 移除

**注意**：当晶圆在腔室中时，它同时存在于 `tokens` 和 `release_schedule` 中。因此容量检查只需检查 `release_schedule`，因为它覆盖了所有承诺（包括已进入的）。

### 奖励塑形

奖励结构包含：
- 加工奖励：处于加工时间内时给予奖励
- 超时惩罚：超过 `processing_time + P_Residual_time` 给予惩罚
- 预警惩罚：接近报废阈值时给予密集惩罚
- 安全裕量奖励：保持裕量给予正向奖励
- 释放时间违规惩罚：预测容量冲突时给予惩罚
- 时间成本：时间推进的固定成本

### 机械手协作

机械手分工降低冲突概率：
- `TM2`：负责 LP1/LP2/s1/s2/s4/s5/LP_done
- `TM3`：负责 s2/s3/s4

在使能判断中加入容量约束，避免向满腔室发送晶圆。

### 机器轮换策略

对多机并行腔室使用轮换策略分配机器：
- 记录 `last_machine`
- 每次进入腔室时轮换分配
- 降低负载不均

### 性能优化

可选优化路径：
- 奖励计算向量化
- 索引缓存加速查询
- 按类型缓存库所列表
- 批量更新 token 滞留时间

### 后续改进方向

- 动态路线选择策略（基于负载与预计释放时间）
- 更精细的机械手调度策略
- 自适应奖励权重调整
