## pn.py 设计说明

本文档说明 `solutions/Continuous_model/pn.py` 的关键设计决策与实现思路。

### 设计目标

- 支持双路线的晶圆加工流程
- 支持双机械手协作并避免拥堵
- 建模驻留约束，模拟真实工艺限制
- 提供可训练的奖励塑形与可视化工具

### 双路线分流

在 `s1` 处根据晶圆颜色决定路线：
- `color=1` 走路线1：`LP1 -> s1 -> s2 -> s3 -> s4 -> s5 -> LP_done`
- `color=2` 走路线2：`LP2 -> s1 -> s5 -> LP_done`

路线上 `s2`/`s4` 为交接缓冲点（无驻留约束），`s1`/`s3`/`s5` 为核心加工腔室（有驻留约束）。

### 释放时间追踪机制

目的：提前检测下游容量冲突，避免调度导致拥堵。

实现要点：
- 当晶圆进入运输位时记录预计进入时间与释放时间
- 沿路线链式传播到下游腔室
- 若下游腔室已满且预计进入时间早于最早释放时间，则触发惩罚

### 奖励塑形

奖励结构包含：
- 加工奖励：处于加工时间内时给予奖励
- 超时惩罚：超过 `processing_time + P_Residual_time` 给予惩罚
- 预警惩罚：接近报废阈值时给予密集惩罚
- 安全裕量奖励：保持裕量给予正向奖励
- 释放时间违规惩罚：预测容量冲突时给予惩罚
- 时间成本：时间推进的固定成本

### 机械手协作

机械手分工降低冲突概率：
- `TM2`：负责 LP1/LP2/s1/s2/s4/s5/LP_done
- `TM3`：负责 s2/s3/s4

在使能判断中加入容量约束，避免向满腔室发送晶圆。

### 机器轮换策略

对多机并行腔室使用轮换策略分配机器：
- 记录 `last_machine`
- 每次进入腔室时轮换分配
- 降低负载不均

### 性能优化

可选优化路径：
- 奖励计算向量化
- 索引缓存加速查询
- 按类型缓存库所列表
- 批量更新 token 滞留时间

### 后续改进方向

- 动态路线选择策略（基于负载与预计释放时间）
- 更精细的机械手调度策略
- 自适应奖励权重调整
