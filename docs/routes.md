## 1 技术路线

- **路线一**：利用神经网络优化“搜索树/数学规划算法”
- **路线二**：模仿学习+端到端神经网络



## 2 调度任务说明

### 2.1路径说明

🟥 **A 路径：LLA-(PM7→PM8→LLC→LLD→LLB)\*5**

🟧 **B 路径：LLA/LLB–PM7/PM8[70]–LLC–PM1/PM2[300]–LLD[70]–LLA/LLB**

🟨 **C 路径：LLA/LLB–PM7/PM8[70]–LLC–PM1/PM2/PM3/PM4[600]–LLD–PM9/PM10[200]–LLA/LLB[70]**

🟩 **D 路径：LLA/LLB–PM7/PM8[70]–PM9/PM10[200]–LLD[70]–LLA/LLB**



### 2.2任务说明

✅任务a

| 晶圆盒编号 | 晶圆编号范围 | 工艺路径 | 任务模式说明                                               |
| ---------- | ------------ | -------- | ---------------------------------------------------------- |
| 1          | 1–25         | A        | 按晶圆盒编号依次加工；当前晶圆未完成时，下一个晶圆不能调度 |
| 2          | 1–25         | A        | 同上                                                       |
| 3          | 1–25         | A        | 同上                                                       |

✅ **任务b**

| 晶圆盒编号 | 晶圆编号范围 | 工艺路径 | 任务模式说明                                               |
| ---------- | ------------ | -------- | ---------------------------------------------------------- |
| 1          | 1–25         | B        | 按晶圆盒编号依次加工；当前晶圆未完成时，下一个晶圆不能调度 |
| 2          | 1–25         | B        | 同上                                                       |
| 3          | 1–25         | B        | 同上                                                       |

✅ **任务c**

| 晶圆盒编号 | 晶圆编号范围 | 工艺路径 | 任务模式说明                     |
| ---------- | ------------ | -------- | -------------------------------- |
| 1          | 1–25         | C        | 各晶圆盒及晶圆盒内晶圆可并发出片 |
| 2          | 1–25         | D        | 同上                             |
| 3          | 1–25         | D        | 同上                             |

✅ **任务d**

| 晶圆盒编号 | 晶圆编号范围 | 工艺路径 | 任务模式说明                     |
| ---------- | ------------ | -------- | -------------------------------- |
| 1          | 1–10         | E        | 各晶圆盒及晶圆盒内晶圆可并发出片 |
| 1          | 11–25        | F        | 同上                             |
| 2          | 1–5          | G        | 同上                             |
| 2          | 6–15         | H        | 同上                             |
| 2          | 16–25        | I        | 同上                             |
| 3          | 1–15         | J        | 同上                             |
| 3          | 16–25        | K        | 同上                             |

------



## 3 启发式算法结果

| 路径 | 方法                   | 最佳 makespan | 对应运行时间 | 备注                |
| ---- | ---------------------- | ------------- | ------------ | ------------------- |
| A    | 普通 A* 剪枝 size=280  | **54648s**    | 65.705s      | h(2) 最优           |
| A    | 节点深度动态加权       | **54685s**    | **3.927s**   | 运行时间优势极大    |
| B    | 普通 A* 剪枝 size=1400 | **18808s**    | 47.038s      | h(2) 最优           |
| B    | 节点深度动态加权       | **13026s**    | **12.466s**  | makespan 提升 30.7% |



## 4 泛化思路

- **规模泛化**：同一模型能够在**晶圆数量不同**的情况下直接应用，而无需重新训练或调整结构。
- **混合类型 Job 泛化**：当**晶圆加工路径和加工时间变化时**，且多种类型的晶圆混合生产时，模型仍然能够有效适用。为构建一个面向实际设备的通用模型，使其能够适配各种加工路径，需要设计一种通用的网络结构。在该结构中，不同晶圆可沿不同路径进行加工，并通过**颜色 Petri 网**对晶圆进行区分与分流，从而统一刻画多路径、多类型晶圆的加工过程。





## 5 物理约束

- LLC、LLD（Load Lock，LL）：LLC与LLD有**一个槽位**，可以放置一片晶圆，LLC与LLD**不存在状态转换**。
- LLA和LLB各有两个槽位S1和S2，进入要从S2进入，出去要从S1出。LLA与LLB从大气转换为真空状态需要15s，从真空转换为大气状态需要20s，LL一旦开始状态转换必须转换为对应状态。
- TM2（Transfer Module）：双臂机械手，两个手臂（R1与R2）方向呈180°且固定不变，每个手臂可以抓取一片晶圆，**两手臂不能同时做取放晶圆的操作**。TM2负责在LLA、LLB、PM1~6间搬运晶圆，LLA、LLB、PM1~6组成一个正八边形，**TM2在相邻两个模块间移动的时间相同**，TM2从某一模块出发绕行一周的时间为3.2s。TM2取晶圆与放晶圆的时间均为5s。此外，TM2的一个手臂指向某个模块时，另一个手臂刚好可以指向另外一个模块，对应关系详见附表1。
- **给出每个晶圆盒下每片晶圆在各个模块的起止运行时间，以及晶圆完成加工后在PM中的停留时间**。另外，请分别以附表3中路径A和路径B为例，测算出单位时间**（1h）最优产能**
- 此外，由于晶圆加工会导致PM环境污染，因此需要对PM进行**清洁**。一个PM每加工完15片晶圆就需要清洁300s，进行清洁时PM中不能有晶圆。



**🔷 工艺加工模块时间（秒）**

| 模块     | 时间（s） |
| -------- | --------- |
| PM7/PM8  | 70        |
| PM1/PM2  | 300 / 600 |
| PM3/PM4  | 600       |
| PM9/PM10 | 200       |
| LLC      | 0         |
| LLD      | 70        |

**🔷 真空锁操作时间**

| 操作                | 时间    |
| ------------------- | ------- |
| 抽气（大气 → 真空） | **15s** |
| 充气（真空 → 大气） | **20s** |
| 开门/关门           | 1s      |

------

**🔷 机械手时间**

| 机械手      | 操作     | 时间 |
| ----------- | -------- | ---- |
| TM1/TM2/TM3 | 取/放    | 4s   |
| TM1         | 移动     | 1s   |
| TM2/TM3     | 绕行一周 | 4s   |

**🔷 清洗时间**

| 触发         | 清洗时间 |
| ------------ | -------- |
| 空闲≥80s     | 30s      |
| 工艺切换     | 200s     |
| 累计加工13片 | 300s     |



## 6 冲突

**冲突1：**
假设存在两道工序：第一道工序包含两台并行机器，第二道工序仅有一台机器，共有两个 job。若 job1 在时刻 0 于工序1开始加工，同时 job2 也在时刻 0 开始加工，则两者会同时完成工序1。然而，由于工序2只有一台机器，只能同时加工一个 job，必然导致另一个 job 滞留在当前腔室中，从而违反驻留时间约束。因此，需要引入一种“**延迟机制**”，主动推迟后续 job 的开始加工时间，以避免该冲突。基于这个关键约束，PPO的状态输入必须能**捕捉到“阻塞风险”**。

**冲突2：**
一旦引入“延迟机制”，就必须预先获知 job1 在工序2的完成（或离开）时间，才能准确确定 job2 应被延迟至何时开始加工。这带来了对未来工序状态的依赖问题。在FFSJ问题中，会产生“**链式影响**”，只有最后的工序确定了离开时间，才能反推前面工序的时间。

<img src="C:\Users\khand\OneDrive\研一\调度问题\assets\image-20260119231432170.png" alt="image-20260119231432170" style="zoom: 33%;" />




## 7 RL说明



### 7.1状态

- [x] 部分标识
- [x] 历史动作序列
- [ ] petri网中的结构信息等



### 7.2 动作空间

- [ ] 动作id



### 7.3 奖励函数

- [ ] 对于ppo来说，可以丰富奖励函数，手上滞留时间惩罚
- [x] 时间变化量



### 7.4 训练

- [ ] 分段训练，约束逐步收紧
  - [ ] 加入代数
  - [ ] 设计分段思路















## ~~8 逆向 Petri 网调度核心规则 (Backward Scheduling Rules)~~

反向执行的时候，如果工序2有2台并行机器，工序1有1台机器。如果同时安排2个job在工序2处，只有1个job可以返回到工序1，另一个job必须得留在原地被迫超时。



#### 规则 1：变迁发射规则

该规则定义了在“逆向时间轴”上变迁如何发射以及时钟如何推进：

- **变迁发射时刻 ($t_1$)**：必须满足约束 $t_1 \le \min(clock, pre\_token.leavetime-pre\_token.processtime)$。这里 $t_1$ 代表该变迁在逆向逻辑中的启动时间。

- **Token 状态更新**：变迁发射后，产出的新 Token 进入后置库所（即原工艺路径中的上游模块）的时刻更新为 $pst\_tok.leavetime=t_1 - transition\_time$

- **全局时钟推进**：发射任务完成后，同步更新全局逆向时钟 $clock = t_1 - transition\_time$。

  > *注：在这种逻辑下，逆向时钟是从一个比较大的数递减的*

#### 规则 2：Token 消耗优先级 (FIFO Rule)

该规则定义了当库所内存在多个可选 Token（如并行机器 PM1 中有多个晶圆）时，变迁发射的决策顺序：

- **消耗原则**：严格遵循 **先进先出 (FIFO)** 原则。
- **逻辑对应**：在逆向调度流程中，“先进入”库所的 Token 对应的是正向调度中“越晚结束”的任务（即 $leavetime$ 较大的 Token）。





