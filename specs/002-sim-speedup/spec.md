# Feature Specification: 加速 Petri 网模拟器性能

**Feature Branch**: `002-sim-speedup`  
**Created**: 2026-01-25  
**Status**: Draft  
**Input**: User description: "加速@solutions/Continuous_model/pn.py 单位时间内模拟步数"

## Clarifications

### Session 2026-01-25

- Q: 性能目标的适用场景是什么？100k 步/秒的目标应在哪些场景下达到？ → A: 提供"极速模式"配置，训练时可禁用非关键功能以达到 100k 步/秒
- Q: 在达到 100k 步/秒时，功能一致性要求如何？ → A: 核心功能（状态转换、奖励）必须一致，但可选追踪功能可在极速模式下禁用
- Q: 极速模式下可禁用的功能范围是什么？哪些功能必须保留？ → A: 仅禁用详细统计追踪（wafer_stats），释放时间链式更新和冲突检测必须保留，不能禁用
- Q: 性能目标的测试场景和硬件假设是什么？ → A: 在标准开发机器（现代 CPU，如 Intel i7/AMD Ryzen 7 或同等性能）上，使用训练模式配置（with_reward=True, detailed_reward=False, 极速模式启用）进行测试
- Q: 性能测试中的动作选择策略是什么？如何从可用动作中选择？ → A: 随机从 [enable, wait] 中选择（如果有 enabled 则从两者中随机选，否则只能 wait），以更真实地模拟训练场景
- Q: wait 和 enable 中的每一个动作的概率是否相等？ → A: 是的，wait 和每个 enabled 动作的概率相等。如果有 n 个 enabled 动作，则每个动作（包括 wait）的概率为 1/(n+1)

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 提高模拟吞吐量 (Priority: P1)

研究人员和强化学习训练系统需要更快的 Petri 网模拟执行速度，以便在相同时间内完成更多训练 episode 或实验迭代。系统应提供"极速模式"配置，允许在训练时禁用非关键功能以达到 1 秒内执行超过 100,000 个模拟步数的目标。

**Why this priority**: 这是核心性能需求，直接影响训练效率和实验迭代速度。更快的模拟速度意味着可以在相同时间内探索更多策略空间，加快模型收敛。极速模式专门针对强化学习训练场景优化，可显著减少训练耗时。

**Independent Test**: 可以通过运行固定数量的模拟步数（例如 100,000 步）并测量实际执行时间来进行独立测试。在极速模式下，系统应在标准开发机器上，使用训练模式配置（with_reward=True, detailed_reward=False, 极速模式启用），在 1 秒内完成至少 100,000 个模拟步数。测试时动作选择策略：从所有可用动作（所有 enabled 动作 + wait）中均匀随机选择，每个动作的概率相等。如果有 n 个 enabled 动作，则每个动作（包括 wait）的概率为 1/(n+1)。如果没有 enabled 动作，则只能选择 wait。

**Acceptance Scenarios**:

1. **Given** 一个配置好的 Petri 网模拟器（极速模式，训练模式配置），**When** 在标准开发机器上执行 100,000 个模拟步数，**Then** 总执行时间应不超过 1 秒
2. **Given** 强化学习训练系统（极速模式），**When** 运行一个完整的训练 episode（从初始状态到完成或报废），**Then** episode 执行时间应比优化前减少至少 15%
3. **Given** 批量训练场景（极速模式），**When** 连续运行 100 个 episode，**Then** 总执行时间应比优化前减少至少 20%，且核心功能（状态转换、奖励计算）保持一致

---

### User Story 2 - 保持模拟准确性 (Priority: P1)

性能优化不应改变模拟器的核心行为或结果，确保优化后的模拟器产生与优化前相同的状态转换和奖励计算。在极速模式下，核心功能（状态转换、奖励计算、报废检测）必须保持一致，但可选追踪功能（如详细统计追踪、释放时间链式更新）可以被禁用以提升性能。

**Why this priority**: 性能优化必须以不改变核心功能为前提，否则优化将失去意义。训练系统依赖模拟器行为的可重复性和准确性。核心功能的一致性确保训练结果的有效性，而可选功能的禁用则允许在性能和调试能力之间取得平衡。

**Independent Test**: 可以通过运行相同的随机种子和动作序列，比较优化前后的最终状态、奖励序列和核心事件日志来进行独立测试。核心功能结果应完全一致，但可选追踪数据在极速模式下可能缺失。

**Acceptance Scenarios**:

1. **Given** 相同的初始状态和随机种子，**When** 执行相同的动作序列（极速模式），**Then** 优化后的模拟器应产生与优化前相同的最终状态、token 分布和总奖励
2. **Given** 相同的配置参数，**When** 运行完整的 episode（极速模式），**Then** 优化后的模拟器应产生相同的完成时间、报废事件和核心奖励值
3. **Given** 相同的输入序列，**When** 检查所有中间状态（极速模式），**Then** 优化后的模拟器在每个步骤的核心状态应与优化前完全匹配

---

### User Story 3 - 支持可配置的性能优化和极速模式 (Priority: P1)

系统应允许用户选择性地启用或禁用特定的性能优化措施，并提供"极速模式"配置。极速模式专门针对强化学习训练场景优化，可禁用非关键追踪功能以达到 1 秒内执行超过 100,000 个模拟步数的目标。

**Why this priority**: 在开发阶段，用户可能需要详细的调试信息或验证优化正确性，此时可以禁用某些优化。在生产训练中，则可以启用极速模式以获得最佳性能。极速模式是减少强化学习训练耗时的关键功能。

**Independent Test**: 可以通过配置开关来启用/禁用优化和极速模式，并验证核心功能一致性。禁用优化时应恢复到原始行为。

**Acceptance Scenarios**:

1. **Given** 配置为禁用所有性能优化，**When** 运行模拟，**Then** 行为应与未优化版本完全一致
2. **Given** 配置为启用极速模式（训练模式配置），**When** 在标准开发机器上运行模拟，**Then** 应在 1 秒内执行超过 100,000 个模拟步数，且核心功能保持一致
3. **Given** 配置为启用部分优化（非极速模式），**When** 运行模拟，**Then** 应获得相应的性能提升，且所有功能保持正确

---

### Edge Cases

- 当模拟器处于空闲状态（所有变迁都不可使能）时，性能优化应如何处理？
- 当 token 数量非常大（例如 100+ 个晶圆）时，优化措施是否仍然有效？
- 当奖励计算配置为返回详细分解（detailed_reward=True）时，性能优化是否会影响详细信息的准确性？
- 在极速模式下，哪些功能可以被禁用以提升性能？
- 极速模式是否适用于所有训练场景，还是仅适用于特定配置？
- 当模拟器接近完成状态（大部分晶圆已处理）时，优化措施是否仍然有效？
- 当系统检测到报废事件时，性能优化是否会影响报废检测的准确性？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须在保持功能完全一致的前提下，提高单位时间内可执行的模拟步数
- **FR-002**: 系统必须优化 `calc_reward` 函数的计算效率，减少不必要的循环和重复计算
- **FR-003**: 系统必须优化 `_resource_enable` 和 `get_enable_t` 函数，减少使能条件检查的计算开销
- **FR-004**: 系统必须优化 `_fire` 函数中的状态更新逻辑，减少每次变迁执行时的开销
- **FR-005**: 系统必须优化 `_update_stay_times` 函数，避免在不需要时更新所有 token 的停留时间
- **FR-006**: 系统必须支持可配置的性能优化开关，允许用户选择性地启用/禁用优化措施
- **FR-007**: 系统必须提供"极速模式"配置，允许在训练时禁用非关键功能（如详细统计追踪 wafer_stats）以达到 1 秒内执行超过 100,000 个模拟步数的目标
- **FR-008**: 系统必须在性能优化后保持核心功能的行为一致性，包括状态转换、奖励计算、报废检测等。释放时间链式更新和冲突检测必须保留，不能禁用
- **FR-009**: 系统必须优化数据结构访问模式，减少不必要的列表遍历和字典查找
- **FR-010**: 系统必须优化释放时间追踪逻辑，减少链式更新的计算开销，但此功能必须保留，不能禁用（链式冲突检测很重要）
- **FR-011**: 系统必须优化晶圆统计追踪逻辑（wafer_stats），减少每次变迁时的记录开销，或在极速模式下允许禁用此功能

### Key Entities

- **性能优化配置**: 包含各种优化开关的配置对象，允许用户控制哪些优化措施被启用
- **模拟步数计数器**: 用于测量和报告单位时间内执行的模拟步数
- **性能基准测试**: 用于验证优化效果的测试套件，确保功能一致性

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 在极速模式下，系统必须在标准开发机器（现代 CPU，如 Intel i7/AMD Ryzen 7 或同等性能）上，使用训练模式配置（with_reward=True, detailed_reward=False, 极速模式启用），在 1 秒内执行超过 100,000 个模拟步数（目标：>10^5 步/秒）
- **SC-002**: 在相同硬件配置下，执行 1000 个模拟步数的总执行时间应比优化前减少至少 20%
- **SC-003**: 在相同硬件配置下，完成一个完整 episode（从初始状态到完成或报废）的平均执行时间应比优化前减少至少 15%
- **SC-004**: 在批量训练场景下（连续运行 100 个 episode），总执行时间应比优化前减少至少 20%
- **SC-005**: 优化后的模拟器在相同输入下应产生与优化前相同的核心结果（状态、奖励、核心事件、释放时间追踪），核心功能一致性达到 100%。详细统计追踪（wafer_stats）在极速模式下可以缺失，但释放时间链式更新和冲突检测必须保留
- **SC-006**: 性能优化不应增加内存使用量超过 10%，确保优化不会导致内存问题
- **SC-007**: 在启用极速模式的情况下，模拟器应能稳定运行至少 10000 个 episode 而不出现性能退化或错误

## Assumptions

- 用户主要关注 CPU 计算性能，而非内存使用（在合理范围内）
- 性能优化主要针对单线程执行场景，多线程优化不在本次范围
- 现有的 Petri 网结构和业务逻辑保持不变，只优化计算效率
- 用户接受通过配置开关来控制优化措施，而非硬编码优化
- 性能测试将在标准开发机器（现代 CPU，如 Intel i7/AMD Ryzen 7 或同等性能）上进行
- 100k 步/秒的性能目标基于训练模式配置（with_reward=True, detailed_reward=False, 极速模式启用）

## Dependencies

- 依赖于现有的 `solutions/Continuous_model/pn.py` 实现
- 依赖于 `data/petri_configs/env_config.py` 中的配置系统
- 需要与强化学习训练系统（`solutions/PPO`）保持兼容
- 需要与可视化系统（`solutions/Continuous_model/test_env.py`）保持兼容

## Out of Scope

- 多线程或并行化优化（本次仅优化单线程性能）
- 改变 Petri 网的数学模型或业务逻辑
- 优化网络 I/O 或文件读写性能
- 优化可视化渲染性能（仅优化模拟器核心逻辑）
- 改变 API 接口或数据结构的外部接口
