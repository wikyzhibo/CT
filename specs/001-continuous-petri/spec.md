# Feature Specification: 连续 Petri 网晶圆加工仿真系统

**Feature Branch**: `001-continuous-petri`  
**Created**: 2026-01-25  
**Status**: Draft  
**Input**: User description: "@solutions/Continuous_model/pn.py 获取需求文档"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 晶圆加工流程仿真 (Priority: P1)

用户需要能够模拟晶圆在制造系统中的完整加工流程，从加载端口（LP）开始，经过多个加工腔室（s1, s2, s3, s4, s5），最终到达完成端口（LP_done）。系统必须能够追踪每个晶圆在系统中的位置、状态和滞留时间。

**Why this priority**: 这是系统的核心功能，所有其他功能都依赖于这个基础流程。没有这个功能，系统无法提供任何价值。

**Independent Test**: 可以通过初始化系统、执行一系列变迁动作、验证晶圆从 LP 移动到 LP_done 的完整流程来独立测试。测试应验证晶圆按照预定路线（LP -> s1 -> s2 -> s3 -> s4 -> s5 -> LP_done）移动，并且系统能够正确追踪每个晶圆的状态。

**Acceptance Scenarios**:

1. **Given** 系统已初始化，包含 N 个晶圆在 LP 中，**When** 执行一系列变迁动作，**Then** 所有晶圆最终都到达 LP_done，且系统时间正确推进
2. **Given** 晶圆在加工腔室中，**When** 达到加工时间后，**Then** 晶圆可以被移出腔室并进入下一个阶段
3. **Given** 系统中有多个晶圆同时加工，**When** 执行动作，**Then** 系统能够正确追踪每个晶圆的位置和状态

---

### User Story 2 - 奖励和惩罚机制 (Priority: P1)

用户需要系统能够根据晶圆加工状态计算奖励和惩罚，以支持强化学习训练。系统必须能够识别正常加工、超时、预警等状态，并相应地给予奖励或惩罚。

**Why this priority**: 奖励机制是强化学习训练的核心，直接影响训练效果。系统必须能够准确计算各种场景下的奖励值。

**Independent Test**: 可以通过设置不同的晶圆状态（正常加工、超时、预警等），执行 step 操作并验证返回的奖励值是否正确来独立测试。测试应验证加工奖励、超时惩罚、预警惩罚、安全裕量奖励等各项奖励机制都能正确计算。

**Acceptance Scenarios**:

1. **Given** 晶圆在加工腔室内正常加工，**When** 计算奖励，**Then** 系统给予正向加工奖励
2. **Given** 晶圆在加工腔室内超过允许滞留时间，**When** 计算奖励，**Then** 系统施加超时惩罚
3. **Given** 晶圆接近报废时间（slack < T_warn），**When** 计算奖励，**Then** 系统施加预警惩罚
4. **Given** 晶圆有足够的安全裕量（slack > T_safe），**When** 计算奖励，**Then** 系统给予安全裕量奖励

---

### User Story 3 - 释放时间追踪和违规检测 (Priority: P2)

用户需要系统能够追踪每个加工腔室的预估释放时间，并在晶圆预计进入时间违反释放约束时进行检测和惩罚。这有助于防止下游腔室堵塞。

**Why this priority**: 释放时间追踪是优化系统性能的关键机制，能够提前预测和避免堵塞问题，提高系统吞吐量。

**Independent Test**: 可以通过设置腔室队列已满的情况，尝试将新晶圆送入该腔室，验证系统是否能够检测到违规并施加惩罚来独立测试。

**Acceptance Scenarios**:

1. **Given** 晶圆进入运输位，**When** 系统记录预估释放时间，**Then** 系统能够链式传播释放时间到下游腔室
2. **Given** 下游腔室队列已满且预估进入时间早于最早释放时间，**When** 系统检测违规，**Then** 系统施加释放时间违规惩罚
3. **Given** 晶圆实际进入腔室，**When** 系统更新精确释放时间，**Then** 系统能够链式更新下游腔室的预估释放时间

---

### User Story 4 - 晶圆统计追踪 (Priority: P2)

用户需要系统能够追踪每个晶圆在系统中的滞留时间统计，包括系统总滞留时间、各腔室滞留时间、运输位滞留时间等，以便分析和优化系统性能。

**Why this priority**: 统计信息对于性能分析和优化至关重要，帮助用户了解系统瓶颈和改进方向。

**Independent Test**: 可以通过执行完整的晶圆加工流程，然后调用统计函数，验证返回的统计数据是否准确来独立测试。

**Acceptance Scenarios**:

1. **Given** 晶圆完成加工流程，**When** 查询统计信息，**Then** 系统返回准确的系统滞留时间、各腔室滞留时间和运输位滞留时间
2. **Given** 多个晶圆同时加工，**When** 查询统计信息，**Then** 系统返回所有晶圆的平均和最大滞留时间
3. **Given** 晶圆在不同腔室中，**When** 查询统计信息，**Then** 系统能够区分不同腔室（PM7/8, LLC, PM1/2, LLD, PM9/10）的滞留时间

---

### User Story 5 - 报废和停滞检测 (Priority: P2)

用户需要系统能够检测晶圆报废（超过允许滞留时间）和系统停滞（连续等待时间过长）的情况，以便及时终止无效的训练 episode。

**Why this priority**: 报废和停滞检测能够避免浪费计算资源在无效的训练场景上，提高训练效率。

**Independent Test**: 可以通过设置晶圆超过允许滞留时间，或连续执行 WAIT 动作超过阈值，验证系统是否能够正确检测并终止 episode 来独立测试。

**Acceptance Scenarios**:

1. **Given** 晶圆在加工腔室内超过 processing_time + P_Residual_time，**When** 系统检查报废，**Then** 系统检测到报废并返回报废标志
2. **Given** 系统连续执行 WAIT 动作超过 idle_timeout 时间，**When** 系统检查停滞，**Then** 系统检测到停滞并施加停滞惩罚
3. **Given** 系统配置为 stop_on_scrap=True，**When** 检测到报废，**Then** 系统终止 episode

---

### Edge Cases

- 当所有晶圆都已完成加工时，系统应正确识别完成状态并给予完成奖励
- 当系统时间超过 MAX_TIME 时，系统应终止并返回超时标志
- 当加工腔室容量已满时，系统应禁用向该腔室发送晶圆的动作
- 当机械手资源不可用时，系统应正确处理资源约束
- 当多个晶圆同时完成加工时，系统应正确处理并发情况
- 当释放时间追踪队列为空时，系统应正确处理边界情况

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须能够构建和初始化 Petri 网模型，包含加载端口、加工腔室、运输位、机械手资源等所有必要组件
- **FR-002**: 系统必须能够执行 Petri 网变迁动作，包括晶圆在腔室间的移动和机械手操作
- **FR-003**: 系统必须能够追踪每个晶圆的位置、状态和进入时间
- **FR-004**: 系统必须能够计算时间窗口内的奖励和惩罚，包括加工奖励、超时惩罚、预警惩罚、安全裕量奖励等
- **FR-005**: 系统必须能够追踪每个加工腔室的预估释放时间，并支持链式传播到下游腔室
- **FR-006**: 系统必须能够检测释放时间违规（预计进入时间早于最早释放时间且队列已满）
- **FR-007**: 系统必须能够追踪每个晶圆在系统中的完整滞留时间统计，包括系统总时间、各腔室时间和运输位时间
- **FR-008**: 系统必须能够检测晶圆报废（超过允许滞留时间）
- **FR-009**: 系统必须能够检测系统停滞（连续等待时间超过阈值）
- **FR-010**: 系统必须能够支持双机械手协作（TM2 和 TM3），每个机械手有特定的可达腔室范围
- **FR-011**: 系统必须能够支持多机器腔室（如 s1, s3, s5 容量为 2），并实现轮换分配策略
- **FR-012**: 系统必须能够区分有驻留约束的腔室（type=1）和无驻留约束的腔室（type=5）
- **FR-013**: 系统必须能够重置到初始状态，包括清空所有晶圆、重置时间、清空统计信息等
- **FR-014**: 系统必须能够生成甘特图可视化，展示晶圆加工时间线
- **FR-015**: 系统必须能够返回详细的奖励分解（当 detailed_reward=True 时），包括各项奖励和惩罚的明细

### Key Entities

- **Place（库所）**: 表示系统中的位置，包括加载端口、加工腔室、运输位、机械手资源等。关键属性包括名称、容量、加工时间、类型、当前 token 队列、释放时间调度队列等
- **Token（令牌）**: 表示晶圆在系统中的实例，包含进入时间、滞留时间、晶圆编号、机器编号等属性
- **Transition（变迁）**: 表示系统中的动作，包括晶圆移动和机械手操作，有前置库所和后置库所的关系
- **Petri Net（Petri 网）**: 整个系统模型，包含所有库所、变迁、初始标记、容量约束等，支持时间推进和状态转换

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 系统能够成功模拟至少 10 个晶圆的完整加工流程（从 LP 到 LP_done），成功率 100%
- **SC-002**: 系统能够正确计算奖励值，加工奖励、超时惩罚、预警惩罚等各项机制都能准确反映晶圆状态
- **SC-003**: 系统能够在晶圆进入运输位后 1 秒内完成释放时间的预估和链式传播
- **SC-004**: 系统能够准确检测释放时间违规，当队列已满且预计进入时间早于最早释放时间时，违规检测准确率 100%
- **SC-005**: 系统能够追踪所有晶圆的完整统计信息，包括系统滞留时间、各腔室滞留时间、运输位滞留时间，数据准确率 100%
- **SC-006**: 系统能够在晶圆超过允许滞留时间后立即检测到报废，检测延迟不超过 1 个时间单位
- **SC-007**: 系统能够在连续等待时间超过阈值后立即检测到停滞，检测延迟不超过 1 个时间单位
- **SC-008**: 系统能够支持双机械手协作，每个机械手能够正确访问其可达范围内的腔室，无资源冲突
- **SC-009**: 系统能够在重置后恢复到初始状态，所有状态变量（时间、晶圆位置、统计信息等）都正确重置
- **SC-010**: 系统能够生成准确的甘特图，展示所有晶圆的加工时间线，可视化信息与系统状态一致
